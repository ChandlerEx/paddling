<!doctype html>
<html lang="en">
<head>
<link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encinal Paddling Dashboard</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{
    --bg:#0b1220; --fg:#e9eef7; --muted:#9fb0c9; --card:#101a2e; --accent:#6cc0ff;
    --good:#32d296; --warn:#ffd166; --bad:#ff6b6b; --divider:rgba(255,255,255,.06);
    --ink:#0d2235; --wave:#0077b6;
  }

  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}

  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* (was header{…}) — scope so it doesn't hit the top site header */
  .wrap > header{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:12px}
  .wrap > header h1{font-size:20px;line-height:1.2;margin:0;letter-spacing:.2px}
  .wrap > header .meta{font-size:12px;color:var(--muted)}

  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:720px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border-radius:14px;padding:14px 14px 16px;
    box-shadow:0 2px 12px rgba(0,0,0,.25);min-height:140px}
  .card h2{margin:0 0 10px;font-size:16px;letter-spacing:.3px;color:var(--accent);
    display:flex;align-items:center;gap:8px}
  .icon{width:18px;height:18px;opacity:.9;display:inline-block}
  .icon path,.icon rect,.icon circle,.icon line,.icon polyline,.icon polygon{stroke:currentColor;fill:none}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:baseline}
  .big{font-size:36px;font-weight:700}
  .unit{font-size:14px;color:var(--muted);margin-left:6px}
  .sub{font-size:14px;color:var(--muted)}
  .list{margin:6px 0 0 0;padding:0;list-style:none}
  .list li{padding:6px 0;border-bottom:1px solid var(--divider)}
  .list li:last-child{border-bottom:0}
  .status{font-size:12px;color:var(--muted);margin-top:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .small{font-size:12px;color:var(--muted)}
  .pill{font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);margin-left:8px}
  .links{margin-left:auto;font-size:12px}
  .links a{color:var(--muted);text-decoration:none}
  .links a:hover{text-decoration:underline}
  .fullwidth{grid-column:1 / -1}
  .leaflet-container{background:#0b1220}

  /* New site header (boat + title + anniversary) */
  .site-header{text-align:center;padding:16px 12px}
  .site-header .logo{height:68px;width:auto;display:block;margin:0 auto 6px}
  .site-header .site-title{margin:0;font:700 2rem/1.1 system-ui;color:var(--fg)}
  .site-header .tagline{margin:4px 0 0;font:italic 1.05rem/1.2 system-ui;color:var(--fg)}

  /* Page title + data sources */
  .page-title{margin:12px 0 8px;font:700 1.4rem/1.2 system-ui;color:#e9eef7}
  .sources{margin:0 0 8px}
  .sources>summary{cursor:pointer;user-select:none;color:var(--accent);font-size:.95rem}
  .pill.mono{display:inline-block;margin-top:6px}

  /* Footer with clock */
  .site-footer{position:sticky;bottom:0;background:var(--card);color:var(--fg);
    font:500 .95rem/1.3 system-ui;text-align:center;padding:8px 10px;border-top:1px solid var(--divider)}

  @media (max-width:520px){
    .site-header .logo{height:56px}
    .site-header .site-title{font-size:1.6rem}
  }
</style>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
</head>
<body>
<!-- Header START -->
<header class="site-header">
  <img src="assets/img/BoatNoBG.png" alt="No Hulis boat" class="logo">
  <h1 class="site-title">NoHulis.com</h1>
  <p class="tagline">Happy Anniversary, Babyo!</p>
</header>
<!-- Header END -->

<div id="advisoryBanner" style="display:none; background:#ff6b6b; color:#fff; padding:8px; text-align:center; font-weight:700; border-bottom:1px solid rgba(0,0,0,.2)">
  <!-- populated by JS -->
</div>

<div class="wrap">
  <div class="grid">
    <section class="card fullwidth" id="camCard">
      <h2>
        <!-- camera icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l2-3h6l2 3h4v13H3z"/>
          <circle cx="12" cy="13" r="4" stroke-width="2"/>
        </svg>
        From South Shore Towards the Boat Ramp (refreshes every 2 minutes)
      </h2>
      <div>
        <img id="alamedaCam"
            src="https://boardsportscalifornia.com/boardsportscalifornia.com/alamedacam.jpg"
            alt="Alameda Cam"
            style="width:100%;border-radius:0.5rem;" />
      </div>
      <div class="status small" id="camStatus"></div>
    </section>

    <section class="card" id="waterTempCard">
      <h2>
        <!-- droplet -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" d="M12 3C12 3 6 10 6 14a6 6 0 0 0 12 0c0-4-6-11-6-11z"/>
        </svg>
        Water Temperature
      </h2>
      <div class="row">
        <div class="big" id="waterTemp">--</div><div class="unit">°F</div>
      </div>
      <div class="status small" id="waterTempTime"></div>
    </section>

    <section class="card" id="airTempCard">
      <h2>
        <!-- thermometer -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" d="M10 6a2 2 0 1 1 4 0v6a4 4 0 1 1-4 0V6z"/>
        </svg>
        Air Temperature
      </h2>
      <div class="row">
        <div class="big" id="airTemp">--</div><div class="unit">°F</div>
      </div>
      <div class="status small" id="airTempTime"></div>
    </section>

    <!-- NEW: Visibility (NWS KOAK) -->
    <section class="card" id="visibilityCard">
      <h2>
        <!-- eye icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
          <circle cx="12" cy="12" r="3" stroke-width="2"/>
        </svg>
        Visibility (KOAK)
      </h2>
      <div class="row">
        <div class="big" id="visibilityMiles">--</div><div class="unit">mi</div>
      </div>
      <div class="status small" id="visibilityTime"></div>
    </section>

    <!-- NEW: Air Quality (AirNow) -->
    <section class="card" id="aqiCard">
      <h2>
        <!-- leaf-ish icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" d="M4 14c0-5 4-8 8-8 4.5 0 8 3.5 8 8 0 3.5-2.5 6-6 6H8a4 4 0 0 1-4-4z"/>
        </svg>
        Air Quality (AQI)
        <span class="pill mono" id="aqiCategory">—</span>
      </h2>
      <div class="row">
        <div class="big" id="aqiValue">--</div><div class="unit">AQI</div>
      </div>
      <div class="sub" id="aqiPollutant">—</div>
      <div class="status small" id="aqiTime"></div>
    </section>

    <section class="card" id="windCard">
      <h2>
        <!-- wind icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" stroke-linecap="round" d="M3 8h10a3 3 0 1 0-3-3"/>
          <path stroke-width="2" stroke-linecap="round" d="M3 12h14a3 3 0 1 1-3 3"/>
          <path stroke-width="2" stroke-linecap="round" d="M3 16h6"/>
        </svg>
        Wind (Alameda 9414750)
        <span class="links"><a id="windMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <div class="row">
        <div class="big" id="windSpeed">--</div><div class="unit">kt</div>
        <div class="sub" id="windGust">(gust -- kt)</div>
        <div class="sub" id="windDir">—° —</div>
      </div>
      <div class="status small" id="windTime">Loading…</div>
    </section>

    <section class="card" id="chopCard">
      <h2>
        <!-- wave icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" stroke-linecap="round" d="M3 16c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/>
        </svg>
        Local Chop (Alameda)
        <span class="links"><a id="chopInfo" target="_blank" rel="noopener">What is this?</a></span>
      </h2>
      <div class="row">
        <div class="big" id="chopHeight">--</div><div class="unit">ft</div>
        <div class="sub" id="chopState">—</div>
      </div>
      <div class="status small">Estimated from wind at NOAA 9414750</div>
    </section>

    <section class="card" id="tideCard">
      <h2>
        <!-- tide icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path stroke-width="2" stroke-linecap="round" d="M3 12h18M5 16c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/>
        </svg>
        Current Tide (Prediction)
        <span class="links"><a id="tideMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <div class="row">
        <div class="big" id="tideNow">--</div><div class="unit">ft</div>
        <div class="sub" id="tideTrend">—</div>
      </div>
      <ul class="list small">
        <li>Next: <span id="tideNext">—</span></li>
      </ul>
      <div class="status small">Predicted highs/lows for 9414750</div>
    </section>

    <section class="card" id="tidesCard">
      <h2>
        <!-- tide gauge icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <rect x="5" y="3" width="14" height="18" rx="2" stroke-width="2"/>
          <path stroke-width="2" d="M7 8h10M7 12h10M7 16h10"/>
        </svg>
        Upcoming High/Low Tides
        <span class="links"><a id="tideMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <ul class="list" id="tidesList"><li>Loading…</li></ul>
      <div class="status small" id="tidesStatus"></div>
    </section>

    <section class="card fullwidth" id="mapCard">
      <h2>Station Map</h2>
      <div id="map" style="height:360px;border-radius:12px;overflow:hidden;"></div>
      <div class="status small" id="mapStatus"></div>
    </section>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const NOAA_TIDE_WIND_STATION = "9414750";     // Alameda
const ERDDAP_BASE            = "https://erddap.cencoos.org/erddap";
const REFRESH_MS             = 5 * 60 * 1000; // 5 minutes
const NWS_STATION = "KOAK";                 // Oakland Airport (closest, reliable vis)
const AQI_LAT = 37.7647, AQI_LON = -122.2730; // Alameda/Crown Beach area
const AIRNOW_API_KEY = "F464CD90-DC2C-41A1-84B0-AE40BBA1FFEC";

function updateStationsPill(){
  const pill = document.getElementById('stationsPill');
  if (!pill) return;
  pill.textContent = `NOAA ${NOAA_TIDE_WIND_STATION} (Wind/Tides + Predictions) • Chop from wind`;
}

document.addEventListener('DOMContentLoaded', () => {
  updateStationsPill();

  const a = document.getElementById('chopInfo');
  if (a) a.href = 'https://en.wikipedia.org/wiki/Sea_state';

  refreshTidePredictions();                 // initial
  setInterval(refreshTidePredictions, 10*60*1000); // every 10 min

  // you can keep adding more stuff here...

});


/* ====== HELPERS ====== */

const mToMi = m => (m == null || isNaN(+m)) ? null : (+m / 1609.344);
function aqiCategoryFor(v){
  if (v == null || isNaN(+v)) return "—";
  const n = +v;
  if (n <= 50) return "Good";
  if (n <= 100) return "Moderate";
  if (n <= 150) return "Unhealthy for Sensitive Groups";
  if (n <= 200) return "Unhealthy";
  if (n <= 300) return "Very Unhealthy";
  return "Hazardous";
}

function aqiColorFor(cat){
  switch (cat){
    case "Good": return "#32d296";                 // matches --good
    case "Moderate": return "#ffd166";             // matches --warn
    case "Unhealthy for Sensitive Groups": return "#ff9f43";
    case "Unhealthy": return "#ff6b6b";            // matches --bad
    case "Very Unhealthy": return "#c56cf0";
    case "Hazardous": return "#6c5ce7";
    default: return "rgba(255,255,255,.08)";
  }
}

async function checkAdvisories() {
  // You can list multiple zones (comma-separated) if you want broader coverage.
  const zones = 'PZZ530';
  const url = `https://api.weather.gov/alerts/active?zone=${zones}`;
  try{
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('nws');
    const j = await r.json();
    const feats = j?.features || [];
    const smallCraft = feats.filter(f => /Small Craft Advisory/i.test(f?.properties?.event));
    const banner = document.getElementById('advisoryBanner');
    if (!banner) return;
    if (smallCraft.length){
      const exp = smallCraft[0]?.properties?.ends ? ` • Ends ${tzFmt(smallCraft[0].properties.ends)}` : '';
      banner.textContent = `⚠️ Small Craft Advisory in effect${exp} — check NWS before paddling`;
      banner.style.display = 'block';
    } else {
      banner.style.display = 'none';
    }
  }catch{
    // hide on error
    const b = document.getElementById('advisoryBanner');
    if (b) b.style.display = 'none';
  }
}

// start it
checkAdvisories();
setInterval(checkAdvisories, 15*60*1000);

function splitStationBin(id) {
  const [base, binStr] = String(id).split('_');
  const bin = binStr != null ? Number(binStr) : null;
  return { base, bin: Number.isFinite(bin) ? bin : null };
}

// --- Tide predictions for Alameda 9414750 ---
async function fetchTideHiLo(station='9414750'){
  const base = 'https://api.tidesandcurrents.noaa.gov/api/prod/datagetter';

  // yesterday .. tomorrow (to guarantee we have the last and next events)
  const now = new Date();
  const y = new Date(now.getTime() - 24*60*60*1000);
  const t = new Date(now.getTime() + 24*60*60*1000);
  const ymd = d => d.toISOString().slice(0,10).replace(/-/g,'');

  const params = new URLSearchParams({
    product:'predictions',
    interval:'hilo',
    time_zone:'lst_ldt',
    datum:'MLLW',
    units:'english',
    format:'json',
    begin_date: ymd(y),
    end_date:   ymd(t),
    station
  });

  const resp = await fetch(`${base}?${params.toString()}`);
  if (!resp.ok) throw new Error(`tide predictions ${resp.status}`);
  const data = await resp.json();
  return data?.predictions || [];
}

function renderTideFromPredictions(preds){
  const now = new Date();
  let prev=null, next=null;
  for (const p of (preds || [])){
    const tt = new Date(p.t);
    if (tt <= now) prev = p; else { next = p; break; }
  }

  let trend = '—';
  if (prev && next){
    trend = (prev.type==='L' && next.type==='H') ? 'flooding (rising)'
         : (prev.type==='H' && next.type==='L') ? 'ebbing (falling)'
         : '—';
  } else if (next) {
    // If it's before the first event of the day
    trend = next.type === 'H' ? 'flooding (rising)' : 'ebbing (falling)';
  }

  // Estimate “now” height if we have a bracket; otherwise show next value
  let nowFt = null;
  if (prev && next){
    const t0 = new Date(prev.t).getTime(), t1 = new Date(next.t).getTime();
    const y0 = parseFloat(prev.v), y1 = parseFloat(next.v);
    const x  = now.getTime();
    const frac = Math.min(1, Math.max(0, (x - t0)/(t1 - t0)));
    nowFt = y0 + (y1 - y0)*frac;
  } else if (next){
    nowFt = parseFloat(next.v); // fallback so the big number isn’t “--”
  }

  const nowEl   = document.getElementById('tideNow');
  const trendEl = document.getElementById('tideTrend');
  const nextEl  = document.getElementById('tideNext');

  if (nowEl)   nowEl.textContent   = nowFt != null && !Number.isNaN(nowFt) ? nowFt.toFixed(1) : '--';
  if (trendEl) trendEl.textContent = trend;
  if (nextEl && next){
    const dt = new Date(next.t);
    const label = `${next.type==='H' ? 'High' : 'Low'} ${parseFloat(next.v).toFixed(1)} ft @ ` +
                  dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    nextEl.textContent = label;
  }
}

async function refreshTidePredictions(){
  try{
    const preds = await fetchTideHiLo('9414750');
    renderTideFromPredictions(preds);
  }catch(e){
    const s = document.getElementById('tideTrend');
    if (s) s.textContent = 'tide data unavailable';
  }
}

// --- Local Chop estimate from wind (Alameda 9414750) ---
function updateChopFromWind(windKt){
  // 0.10 ft per kt is a simple, useful Bay heuristic (cap for sanity)
  const h = Math.max(0, Math.min(3.5, Math.round((windKt * 0.10) * 10) / 10)); // feet
  let state = 'glassy';
  if (windKt >= 6  && windKt < 12) state = 'light chop';
  else if (windKt >= 12 && windKt < 18) state = 'moderate chop';
  else if (windKt >= 18 && windKt < 25) state = 'rough';
  else if (windKt >= 25) state = 'very rough';

  const hEl = document.getElementById('chopHeight');
  const sEl = document.getElementById('chopState');
  if (hEl) hEl.textContent = h.toFixed(1);
  if (sEl) sEl.textContent = state;
}

const toCardinal = deg => {
  if (deg == null || isNaN(deg)) return "—";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(((deg % 360)+360)%360 / 22.5) % 16];
};
const ft   = m => m * 3.28084;
const fmt1 = n => n == null || isNaN(+n) ? "—" : (+n).toFixed(1);
const fmt0 = n => n == null || isNaN(+n) ? "—" : Math.round(+n);
const tzFmt = iso => { try { return new Date(iso).toLocaleString(); } catch { return iso || "—"; } };
const todayYYYYMMDD = () => {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
};
function setClock(){
  const el = document.getElementById('clock');
  if (!el) return;
  el.textContent = new Date().toLocaleString(undefined, {
    weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
  });
}

/* ====== STATION LINKS (maps/info) ====== */
document.addEventListener('DOMContentLoaded', () => {
  // clock
  setClock();
  setInterval(setClock, 60_000);

  // map/info links (guard each in case IDs ever change)
  const wind = document.getElementById('windMap');
  if (wind) wind.href = `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;

  const tide = document.getElementById('tideMap');
  if (tide) tide.href = `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;

  const tide2 = document.getElementById('tideMap2');             // ← add this line
  if (tide2) tide2.href = `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;  // ← and this line

});

/* ====== FETCHERS ====== */

// Visibility (latest) from NWS (meters in properties.visibility.value)
async function getVisibilityNWS() {
  const url = `https://api.weather.gov/stations/${NWS_STATION}/observations/latest`;
  const r = await fetch(url, { headers:{ "Accept":"application/geo+json" }, cache:"no-store" });
  if (!r.ok) throw new Error("nws visibility");
  return r.json();
}

// AirNow AQI near Alameda (PM2.5/O3 are typical; pick highest AQI reported)
async function getAQI() {
  const params = new URLSearchParams({
    format: "application/json",
    latitude: String(AQI_LAT),
    longitude: String(AQI_LON),
    distance: "10",                // miles search radius
    API_KEY: AIRNOW_API_KEY
  });
  const url = `https://www.airnowapi.org/aq/observation/latLong/current/?${params}`;
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("airnow aqi");
  return r.json(); // array of observations by parameter
}

// Water temp (latest)
async function getWaterTemp() {
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=water_temperature&time_zone=lst_ldt&units=english&format=json&station=${NOAA_TIDE_WIND_STATION}&date=latest`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('water temp');
  return r.json();
}

// Air temp (latest)
async function getAirTemp() {
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=air_temperature&time_zone=lst_ldt&units=english&format=json&station=${NOAA_TIDE_WIND_STATION}&date=latest`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('air temp');
  return r.json();
}

function renderTemp(json, valueId, timeId){
  const obs = (json?.data||[])[0]||{};
  document.getElementById(valueId).textContent = fmt1(obs.v);
  if (obs.t && timeId) document.getElementById(timeId).textContent = `As of ${tzFmt(obs.t)}`;
}

// Tides (today hilo)
async function getTidesToday() {
  const day = todayYYYYMMDD();
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=predictions&interval=hilo&time_zone=lst_ldt&datum=MLLW&units=english&format=json` +
    `&station=${NOAA_TIDE_WIND_STATION}&begin_date=${day}&end_date=${day}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('tides'); return r.json();
}

// Wind (latest) – fields are s,g,d
async function getWindLatest() {
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=wind&time_zone=lst_ldt&units=english&format=json&station=${NOAA_TIDE_WIND_STATION}&date=latest`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('wind'); return r.json();
}

// Format YYYYMMDD HH:MM (a real space; URLSearchParams will encode it)
function fmtDateForNOAA(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const HH = String(d.getHours()).padStart(2,'0');
  const MM = String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}${mm}${dd} ${HH}:${MM}`;
}

/* ====== RENDERERS ====== */

function renderVisibilityNWS(json){
  const p = json?.properties || {};
  const visM = p?.visibility?.value;             // meters (can be null)
  const visMi = mToMi(visM);
  const valEl = document.getElementById('visibilityMiles');
  const tEl   = document.getElementById('visibilityTime');

  if (visMi != null) valEl.textContent = fmt1(visMi);
  else valEl.textContent = '--';

  if (p.timestamp) tEl.textContent = `As of ${tzFmt(p.timestamp)}`;
  else tEl.textContent = '';
}

function renderAQI(arr){
  // Pick the highest AQI across pollutants (usually PM2.5 and/or O3 present)
  let best = null;
  for (const o of (arr || [])){
    const v = +o.AQI;
    if (!isNaN(v) && (best == null || v > best.AQI)) best = o;
  }

  const vEl   = document.getElementById('aqiValue');
  const cEl   = document.getElementById('aqiCategory');
  const polEl = document.getElementById('aqiPollutant');
  const tEl   = document.getElementById('aqiTime');

  if (!best){
    vEl.textContent = '--';
    cEl.textContent = '—';
    cEl.style.background = 'rgba(255,255,255,.08)';
    polEl.textContent = '—';
    tEl.textContent = '';
    return;
  }

  const cat = aqiCategoryFor(best.AQI);
  vEl.textContent = Math.round(best.AQI);
  cEl.textContent = cat;
  cEl.style.background = aqiColorFor(cat);
  polEl.textContent = `Dominant: ${best.ParameterName || '—'}`;
  if (best.DateObserved && best.HourObserved != null){
    // AirNow gives local date + hour; display simply
    tEl.textContent = `Observed ${best.DateObserved} ${String(best.HourObserved).padStart(2,'0')}:00 (local)`;
  } else {
    tEl.textContent = '';
  }
}

function renderWind(json) {
  const obs = (json?.data||[])[0]||{};
  const speedKt = parseFloat(obs.s);
  document.getElementById('windSpeed').textContent = fmt0(speedKt);
  updateChopFromWind(speedKt);
  document.getElementById('windGust').textContent  = `(gust ${fmt1(obs.g)} kt)`;
  document.getElementById('windDir').textContent   = `${fmt0(obs.d)}° ${toCardinal(obs.d)}`;
  document.getElementById('windTime').textContent  = obs.t ? `As of ${tzFmt(obs.t)}` : '';
}

function renderTides(json) {
  const ul = document.getElementById('tidesList'); ul.innerHTML='';
  const arr = json?.predictions || [];
  if (!arr.length){ ul.innerHTML='<li>No tide data</li>'; return; }
  for (const p of arr) {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${p.type==='H'?'High':'Low'}</strong> — ${tzFmt(p.t)} — <span class="mono">${(+p.v).toFixed(1)} ft</span>`;
    ul.appendChild(li);
  }
}

// ===== MAP =====
let map, markersLayer, bounds;

function ensureMap() {
  if (map) return map;
  map = L.map('map', { scrollWheelZoom: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  bounds = L.latLngBounds();
  return map;
}

function addMarker(lat, lon, label, linkHref) {
  if (lat == null || lon == null) return;
  ensureMap();
  const m = L.marker([lat, lon]).addTo(markersLayer);
  const inner = linkHref ? `<a href="${linkHref}" target="_blank" rel="noopener">${label}</a>` : label;
  m.bindPopup(inner);
  bounds.extend([lat, lon]);
  fitMarkers(); // <— keep view framed even if markers arrive at different times
}

function fitMarkers() {
  if (!map || !bounds || !bounds.isValid()) return;
  map.fitBounds(bounds.pad(0.2));
}

// NOAA tide/wind station meta (MDAPI only; CORS-safe)
async function getNoaaStationMetaLatLon(stationId) {
  try {
    const u = `https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/${stationId}.json`;
    const r = await fetch(u, { cache: 'no-store' });
    if (!r.ok) return {};
    const j = await r.json();
    const s = j?.stations?.[0] || j?.station || j?.data || j;
    const lat = parseFloat(s?.lat || s?.latitude);
    const lon = parseFloat(s?.lng || s?.lon || s?.longitude);
    return (Number.isFinite(lat) && Number.isFinite(lon)) ? { lat, lon } : {};
  } catch { return {}; }
}

/* ====== CONTROLLER ====== */
async function refreshAll() {
  // Wind
  getWindLatest()
    .then(renderWind)
    .catch(() => { document.getElementById('windTime').textContent = 'Wind unavailable'; });

  // Tides
  getTidesToday()
    .then(renderTides)
    .catch(() => { document.getElementById('tidesList').innerHTML = '<li>Error loading tides</li>'; });
  
  // Water Temp
  getWaterTemp()
    .then(j => renderTemp(j, 'waterTemp', 'waterTempTime'))
    .catch(() => { document.getElementById('waterTemp').textContent = '--'; });

  // Air Temp
  getAirTemp()
    .then(j => renderTemp(j, 'airTemp', 'airTempTime'))
    .catch(() => { document.getElementById('airTemp').textContent = '--'; });
  
  // Visibility (NWS)
  getVisibilityNWS()
    .then(renderVisibilityNWS)
    .catch(() => {
      const e = document.getElementById('visibilityMiles');
      if (e) e.textContent = '--';
      const t = document.getElementById('visibilityTime');
      if (t) t.textContent = 'Visibility unavailable';
    });

  // Air Quality (AirNow)
  getAQI()
    .then(renderAQI)
    .catch(() => {
      const v = document.getElementById('aqiValue');
      if (v) v.textContent = '--';
      const c = document.getElementById('aqiCategory');
      if (c){ c.textContent = '—'; c.style.background = 'rgba(255,255,255,.08)'; }
      const p = document.getElementById('aqiPollutant');
      if (p) p.textContent = '—';
      const t = document.getElementById('aqiTime');
      if (t) t.textContent = 'AQI unavailable';
    });

  // ---- MAP MARKERS (run in parallel; safe if some fail) ----
  (async () => {
    document.getElementById('mapStatus').textContent = 'Loading station locations…';

    // Reset layer + bounds each refresh
    ensureMap();
    markersLayer.clearLayers();
    bounds = L.latLngBounds();

    // Tide/Wind station (same NOAA id)
    try {
      const meta = await getNoaaStationMetaLatLon(NOAA_TIDE_WIND_STATION);
      if (meta.lat!=null && meta.lon!=null) {
        addMarker(meta.lat, meta.lon, `NOAA ${NOAA_TIDE_WIND_STATION} (Tide/Wind)`,
          document.getElementById('tideMap').href);
      }
    } catch {}

    // Camera @ Crown Beach (Boardsports California)
    const cameraIcon = L.icon({
      iconUrl: 'assets/img/camera-icon.svg',  // make sure this path exists
      iconSize: [36, 36],       // 50% larger than 24x24
      iconAnchor: [18, 36],     // bottom center of the icon
      popupAnchor: [0, -18]     // popup just above the icon
    });

    const camLat = 37.7647, camLon = -122.2730;

    // KOAK (NWS station for visibility)
    const koakIcon = L.icon({
      iconUrl: 'assets/img/airport-icon.svg',
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -18]
    });

    // Oakland International Airport (approx)
    const koakLat = 37.7126, koakLon = -122.2197;

    const koakMarker = L.marker([koakLat, koakLon], {
      title: 'KOAK – NWS Station (Visibility)'
    }).bindPopup(
      `<strong>KOAK – NWS Station</strong><br>` +
      `Visibility source for this dashboard.<br>` +
      `<a href="https://api.weather.gov/stations/KOAK" target="_blank" rel="noopener">Station info</a>`
    );

    markersLayer.addLayer(koakMarker);
    bounds.extend([koakLat, koakLon]);
    
    // create the marker
    const camMarker = L.marker([camLat, camLon], {
      icon: cameraIcon,
      title: 'Boardsports California Webcam'
    }).bindPopup('Boardsports California Webcam<br>600 Westline Dr, Alameda, CA 94501');

    // IMPORTANT: add to the same layer group and extend bounds
    markersLayer.addLayer(camMarker);
    bounds.extend([camLat, camLon]);

    // Fit to whatever we have now
    fitMarkers();
    document.getElementById('mapStatus').textContent = '';
  })();
}

// ---- CAMERA SNAPSHOT (updates every 2 min) ----
function refreshCam() {
  const cam = document.getElementById('alamedaCam');
  if (!cam) return;
  const t = Date.now(); // cache-buster
  cam.src = `https://boardsportscalifornia.com/boardsportscalifornia.com/alamedacam.jpg?${t}`;
  const s = document.getElementById('camStatus');
  if (s) s.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
}

refreshAll();
setInterval(refreshAll, REFRESH_MS);
refreshCam();
setInterval(refreshCam, 120000);

</script>
<footer class="site-footer">
  <span id="clock">--:--</span> &nbsp;•&nbsp; Refreshes every 5 min

  <!-- Collapsible sources & methods (keeps IDs, hides clutter on mobile) -->
  <details class="sources">
    <summary>Data Sources &amp; Methodology</summary>
    <div class="mono small" style="margin-top:6px; line-height:1.35">

      <p><strong>Wind (NOAA 9414750 – Alameda)</strong><br>
      <em>Source:</em> NOAA CO-OPS “wind” product for station 9414750 (LST/LDT, English units).<br>
      <em>Method:</em> The dashboard reads the latest observation fields: sustained speed (<code>s</code>, kt), gust (<code>g</code>, kt), and direction (<code>d</code>, degrees).
      Values are displayed directly without smoothing or averaging.</p>

      <p><strong>Local Chop (Estimated)</strong><br>
      <em>Source:</em> Derived from the latest Alameda wind observation.<br>
      <em>Method:</em> Quick bay heuristic: <code>chop height ≈ 0.10 × wind (kt)</code>, capped at ~3.5&nbsp;ft.
      States: glassy (&lt;6 kt), light (6–11), moderate (12–17), rough (18–24), very rough (25+). This is an at-a-glance cue, not a wave model.</p>

      <p><strong>Current Tide (Prediction)</strong><br>
      <em>Source:</em> NOAA CO-OPS tide predictions for station 9414750 (datum <strong>MLLW</strong>, LST/LDT), using the <em>hilo</em> prediction list.<br>
      <em>Method:</em> We find the most recent and the next Hi/Lo events relative to “now” and linearly interpolate their heights to estimate the tide height
      at the current time. Trend is shown as <em>flooding (rising)</em> when moving Low→High and <em>ebbing (falling)</em> when moving High→Low.
      This is a model prediction, not a live water-level sensor.</p>

      <p><strong>Upcoming High/Low Tides</strong><br>
      <em>Source:</em> Same NOAA CO-OPS predictions (MLLW, LST/LDT) for today’s date.<br>
      <em>Method:</em> We list the day’s predicted High/Low events with local times and heights (ft) as provided by CO-OPS.</p>

      <p><strong>Water Temperature (NOAA 9414750)</strong><br>
      <em>Source:</em> NOAA CO-OPS “water_temperature” product at station 9414750.<br>
      <em>Method:</em> The latest available temperature reading is displayed in °F (converted from °C by the API when needed), along with its observation time.</p>

      <p><strong>Air Temperature (NOAA 9414750)</strong><br>
      <em>Source:</em> NOAA CO-OPS “air_temperature” product at station 9414750.<br>
      <em>Method:</em> The latest air temperature is shown in °F with its observation time; no averaging or smoothing is applied.</p>

      <p><strong>Visibility (KOAK – NWS)</strong><br>
      <em>Source:</em> National Weather Service observations for station KOAK (Oakland International Airport).<br>
      <em>Method:</em> We read the latest <code>visibility.value</code> (meters) and convert to miles. Times reflect the station’s observation timestamp.</p>

      <p><strong>Air Quality (AQI – AirNow)</strong><br>
      <em>Source:</em> AirNow “current observations” near Alameda (≈25-mi radius).<br>
      <em>Method:</em> We select the highest AQI among reported parameters (typically PM2.5 and O₃) and show the EPA category color. Time reflects the observation’s local hour.</p>

      <p><strong>Advisory Banner</strong><br>
      <em>Source:</em> National Weather Service (NWS) Alerts API for marine zone <strong>PZZ530</strong>.<br>
      <em>Method:</em> We poll active alerts; if a <em>Small Craft Advisory</em> is present, a banner appears with the advisory and posted end time (local).
      If no alert is active or the API fails, the banner remains hidden.</p>

      <p><strong>Camera (Boardsports California – Alameda)</strong><br>
      <em>Source:</em> Public snapshot endpoint for the Alameda camera.<br>
      <em>Method:</em> The image is refreshed about every 2 minutes with a cache-buster to avoid stale content; the status line shows the last refresh time.</p>

      <p><strong>Station Map</strong><br>
      <em>Source:</em> NOAA CO-OPS MDAPI station metadata for 9414750 (lat/lon), rendered with Leaflet and OpenStreetMap tiles.<br>
      <em>Method:</em> The Alameda station is marked on the map; the view auto-fits to the available markers.</p>

      <p><strong>Intentionally Omitted</strong><br>
      HF Radar surface currents and SFBOFS model currents are not shown to avoid coarse spatial averaging and proxy/availability issues; this dashboard
      focuses on reliable <em>local station signals</em> near Alameda.</p>

    </div>
  </details>

</footer>

</body>
</html>
