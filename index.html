<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encinal Paddling Dashboard</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{
    --bg:#0b1220; --fg:#e9eef7; --muted:#9fb0c9; --card:#101a2e; --accent:#6cc0ff;
    --good:#32d296; --warn:#ffd166; --bad:#ff6b6b; --divider:rgba(255,255,255,.06);
    --ink:#0d2235; --wave:#0077b6;
  }

  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}

  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* (was header{…}) — scope so it doesn't hit the top site header */
  .wrap > header{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:12px}
  .wrap > header h1{font-size:20px;line-height:1.2;margin:0;letter-spacing:.2px}
  .wrap > header .meta{font-size:12px;color:var(--muted)}

  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:720px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border-radius:14px;padding:14px 14px 16px;
    box-shadow:0 2px 12px rgba(0,0,0,.25);min-height:140px}
  .card h2{margin:0 0 10px;font-size:16px;letter-spacing:.3px;color:var(--accent);
    display:flex;align-items:center;gap:8px}
  .icon{width:18px;height:18px;opacity:.9;display:inline-block}
  .icon path,.icon rect,.icon circle,.icon line,.icon polyline,.icon polygon{stroke:currentColor;fill:none}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:baseline}
  .big{font-size:36px;font-weight:700}
  .unit{font-size:14px;color:var(--muted);margin-left:6px}
  .sub{font-size:14px;color:var(--muted)}
  .list{margin:6px 0 0 0;padding:0;list-style:none}
  .list li{padding:6px 0;border-bottom:1px solid var(--divider)}
  .list li:last-child{border-bottom:0}
  .status{font-size:12px;color:var(--muted);margin-top:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .small{font-size:12px;color:var(--muted)}
  .pill{font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);margin-left:8px}
  .links{margin-left:auto;font-size:12px}
  .links a{color:var(--muted);text-decoration:none}
  .links a:hover{text-decoration:underline}
  .fullwidth{grid-column:1 / -1}
  .leaflet-container{background:#0b1220}

  /* New site header (boat + title + anniversary) */
  .site-header{text-align:center;padding:16px 12px}
  .site-header .logo{height:68px;width:auto;display:block;margin:0 auto 6px}
  .site-header .site-title{margin:0;font:700 2rem/1.1 system-ui;color:var(--fg)}
  .site-header .tagline{margin:4px 0 0;font:italic 1.05rem/1.2 system-ui;color:var(--fg)}

  /* Page title + data sources */
  .page-title{margin:12px 0 8px;font:700 1.4rem/1.2 system-ui;color:#e9eef7}
  .sources{margin:0 0 8px}
  .sources>summary{cursor:pointer;user-select:none;color:var(--accent);font-size:.95rem}
  .pill.mono{display:inline-block;margin-top:6px}

  /* Footer with clock */
  .site-footer{position:sticky;bottom:0;background:var(--card);color:var(--fg);
    font:500 .95rem/1.3 system-ui;text-align:center;padding:8px 10px;border-top:1px solid var(--divider)}

  @media (max-width:520px){
    .site-header .logo{height:56px}
    .site-header .site-title{font-size:1.6rem}
  }
</style>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
</head>
<body>
<!-- Header START -->
<header class="site-header">
  <img src="assets/img/BoatNoBG.png" alt="No Hulis boat" class="logo">
  <h1 class="site-title">NoHulis.com</h1>
  <p class="tagline">Happy Anniversary, Babyo!</p>
</header>
<!-- Header END -->

<div class="wrap">
  <div class="grid">
    <section class="card fullwidth" id="camCard">
      <h2>
        <!-- camera icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l2-3h6l2 3h4v13H3z"/>
          <circle cx="12" cy="13" r="4" stroke-width="2"/>
        </svg>
        From South Shore Towards the Boat Ramp (refreshes every 2 minutes)
      </h2>
      <div>
        <img id="alamedaCam"
            src="https://boardsportscalifornia.com/boardsportscalifornia.com/alamedacam.jpg"
            alt="Alameda Cam"
            style="width:100%;border-radius:0.5rem;" />
      </div>
      <div class="status small" id="camStatus"></div>
    </section>

    <section class="card" id="windCard">
      <h2>
        <!-- wind icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" stroke-linecap="round" d="M3 8h10a3 3 0 1 0-3-3"/>
          <path stroke-width="2" stroke-linecap="round" d="M3 12h14a3 3 0 1 1-3 3"/>
          <path stroke-width="2" stroke-linecap="round" d="M3 16h6"/>
        </svg>
        Wind (Alameda 9414750)
        <span class="links"><a id="windMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <div class="row">
        <div class="big" id="windSpeed">--</div><div class="unit">kt</div>
        <div class="sub" id="windGust">(gust -- kt)</div>
        <div class="sub" id="windDir">—° —</div>
      </div>
      <div class="status small" id="windTime">Loading…</div>
    </section>

    <section class="card" id="wavesCard">
      <h2>
        <!-- waves icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" d="M3 16c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/>
          <path stroke-width="2" d="M3 12c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/>
        </svg>
        Waves (CDIP 142 / SF Bar)
        <span class="links"><a id="wavesMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <div class="row">
        <div class="big" id="waveHeight">--</div><div class="unit">ft</div>
        <div class="sub" id="wavePeriod">— s</div>
        <div class="sub" id="waveDir">—° —</div>
      </div>
      <div class="status small" id="wavesTime">Loading…</div>
    </section>

    <section class="card" id="tidesCard">
      <h2>
        <!-- tide gauge icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <rect x="5" y="3" width="14" height="18" rx="2" stroke-width="2"/>
          <path stroke-width="2" d="M7 8h10M7 12h10M7 16h10"/>
        </svg>
        Tides Today (MLLW)
        <span class="links"><a id="tideMap" target="_blank" rel="noopener">Map</a></span>
      </h2>
      <ul class="list" id="tidesList"><li>Loading…</li></ul>
      <div class="status small" id="tidesStatus"></div>
    </section>

    <section class="card" id="currentsCard">
      <h2>
        <!-- current/arrow icon -->
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M5 12h10"/>
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 5l7 7-7 7"/>
        </svg>
        Currents (Next 24h)
        <span class="links"><a id="currentsInfo" target="_blank" rel="noopener">Station</a></span>
      </h2>
      <ul class="list" id="currentsList"><li>Loading…</li></ul>
      <div class="status small" id="currentsStatus"></div>
    </section>

    <section class="card fullwidth" id="mapCard">
      <h2>Station Map</h2>
      <div id="map" style="height:360px;border-radius:12px;overflow:hidden;"></div>
      <div class="status small" id="mapStatus"></div>
    </section>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const NOAA_TIDE_WIND_STATION = "9414750";     // Alameda
const CURRENTS_STATION       = "SFB1201_20";  // Entrance Outside (can change later)
const ERDDAP_BASE            = "https://erddap.cencoos.org/erddap";
const REFRESH_MS             = 5 * 60 * 1000; // 5 minutes
const PROXY_BASE = "https://noaa-currents-proxy.chandler12.workers.dev";  // <-- your Worker URL

function updateStationsPill(resolvedId = CURRENTS_STATION){
  const pill = document.getElementById('stationsPill');
  if (!pill) return;
  pill.textContent = `Tide/Wind:${NOAA_TIDE_WIND_STATION} • Waves:CDIP142 • Currents:${resolvedId}`;
}
document.addEventListener('DOMContentLoaded', () => updateStationsPill());


/* ====== HELPERS ====== */
function splitStationBin(id) {
  const [base, binStr] = String(id).split('_');
  const bin = binStr != null ? Number(binStr) : null;
  return { base, bin: Number.isFinite(bin) ? bin : null };
}

// Try a few bins via the proxy; pass bin separately
async function probeCurrentsBin(base, candidates = [20, 14, 10, 5, 30]) {
  for (const bin of candidates) {
    try {
      const params = new URLSearchParams({ station: base, bin: String(bin), range: '24' });
      const r = await fetch(`${PROXY_BASE}?${params.toString()}`, { cache: 'no-store' });
      if (!r.ok) continue;
      const j = await r.json();
      const rows = j?.current_predictions?.data || [];
      if (rows.length) return { id: `${base}_${bin}`, data: j };
    } catch {
      // try next
    }
  }
  return null;
}

// Optional; keep only if you use it to show loading text
function showCurrStatus(msg) {
  document.getElementById('currentsStatus').textContent = msg;
}

const toCardinal = deg => {
  if (deg == null || isNaN(deg)) return "—";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(((deg % 360)+360)%360 / 22.5) % 16];
};
const ft   = m => m * 3.28084;
const fmt1 = n => n == null || isNaN(+n) ? "—" : (+n).toFixed(1);
const fmt0 = n => n == null || isNaN(+n) ? "—" : Math.round(+n);
const tzFmt = iso => { try { return new Date(iso).toLocaleString(); } catch { return iso || "—"; } };
const todayYYYYMMDD = () => {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
};
function setClock(){
  const el = document.getElementById('clock');
  if (!el) return;
  el.textContent = new Date().toLocaleString(undefined, {
    weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
  });
}

/* ====== STATION LINKS (maps/info) ====== */
document.addEventListener('DOMContentLoaded', () => {
  // clock
  setClock();
  setInterval(setClock, 60_000);

  // map/info links (guard each in case IDs ever change)
  const wind = document.getElementById('windMap');
  if (wind) wind.href = `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;

  const tide = document.getElementById('tideMap');
  if (tide) tide.href = `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;

  const curr = document.getElementById('currentsInfo');
  if (curr) curr.href = `https://api.tidesandcurrents.noaa.gov/dpapi/prod/webapi/stations/${encodeURIComponent(CURRENTS_STATION)}/details.html`;

  const waves = document.getElementById('wavesMap');
  if (waves) waves.href = "https://www.ndbc.noaa.gov/station_page.php?station=46237";
});

document.getElementById('windMap').href  =
  `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;
document.getElementById('tideMap').href  =
  `https://tidesandcurrents.noaa.gov/stationhome.html?id=${NOAA_TIDE_WIND_STATION}`;
document.getElementById('currentsInfo').href =
  `https://api.tidesandcurrents.noaa.gov/dpapi/prod/webapi/stations/${encodeURIComponent(CURRENTS_STATION)}/details.html`; // just a link; CORS doesn't apply
// Waves map default (always present, even before ERDDAP returns)
document.getElementById('wavesMap').href =
  "https://www.ndbc.noaa.gov/station_page.php?station=46237";

/* ====== FETCHERS ====== */
// Tides (today hilo)
async function getTidesToday() {
  const day = todayYYYYMMDD();
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=predictions&interval=hilo&time_zone=lst_ldt&datum=MLLW&units=english&format=json` +
    `&station=${NOAA_TIDE_WIND_STATION}&begin_date=${day}&end_date=${day}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('tides'); return r.json();
}

// Wind (latest) – fields are s,g,d
async function getWindLatest() {
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
    `product=wind&time_zone=lst_ldt&units=english&format=json&station=${NOAA_TIDE_WIND_STATION}&date=latest`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('wind'); return r.json();
}

// Format YYYYMMDD HH:MM (a real space; URLSearchParams will encode it)
function fmtDateForNOAA(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const HH = String(d.getHours()).padStart(2,'0');
  const MM = String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}${mm}${dd} ${HH}:${MM}`;
}

// Currents via Worker — send station (base) + bin separately
async function getCurrentsNext24_DataAPI(stationIdOrCombined) {
  const { base, bin } = splitStationBin(stationIdOrCombined);
  const params = new URLSearchParams({ station: base, range: '24' });
  if (bin != null) params.set('bin', String(bin));
  const url = `${PROXY_BASE}?${params.toString()}`;

  let r, txt;
  try {
    r = await fetch(url, { cache: 'no-store' });
    txt = await r.text();
  } catch (err) {
    console.debug('currents fetch error ->', url, err);
    throw err;
  }

  // ALWAYS log
  console.debug('currents raw ->', url, '\n', txt.slice(0, 500));

  if (!r.ok) {
    throw new Error(`proxy ${r.status} ${txt}`);
  }
  return JSON.parse(txt);
}

// Waves via ERDDAP (CDIP 142 / SF Bar) – also fetch latitude/longitude for Map link
async function getWavesLatestCDIP142() {
  const vars = "time,latitude,longitude,sea_surface_wave_significant_height," +
               "sea_surface_wave_period_at_variance_spectral_density_maximum," +
               "sea_surface_wave_from_direction";
  const url = `${ERDDAP_BASE}/tabledap/edu_ucsd_cdip_142.json?${vars}` +
              "&sea_surface_wave_significant_height>=0&orderByMax(%22time%22)";
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('waves');
  const data = await r.json();
  const cols = data?.table?.columnNames || [];
  const row = (data?.table?.rows || [])[0] || [];
  const i = n => cols.indexOf(n);
  return {
    timeISO: row[i('time')],
    lat: row[i('latitude')],
    lon: row[i('longitude')],
    sigWaveHeightFt: row[i('sea_surface_wave_significant_height')]*3.28084,
    peakPeriodSec: row[i('sea_surface_wave_period_at_variance_spectral_density_maximum')],
    meanDirectionDeg: row[i('sea_surface_wave_from_direction')]
  };
}

/* ====== RENDERERS ====== */
function renderWind(json) {
  const obs = (json?.data||[])[0]||{};
  document.getElementById('windSpeed').textContent = fmt1(obs.s);
  document.getElementById('windGust').textContent  = `(gust ${fmt1(obs.g)} kt)`;
  document.getElementById('windDir').textContent   = `${fmt0(obs.d)}° ${toCardinal(obs.d)}`;
  document.getElementById('windTime').textContent  = obs.t ? `As of ${tzFmt(obs.t)}` : '';
}
function renderTides(json) {
  const ul = document.getElementById('tidesList'); ul.innerHTML='';
  const arr = json?.predictions || [];
  if (!arr.length){ ul.innerHTML='<li>No tide data</li>'; return; }
  for (const p of arr) {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${p.type==='H'?'High':'Low'}</strong> — ${tzFmt(p.t)} — <span class="mono">${(+p.v).toFixed(1)} ft</span>`;
    ul.appendChild(li);
  }
}

// Render DPAPI/“currentPredictions” events
function renderCurrentsFromTable(data) {
  const ul = document.getElementById('currentsList');
  ul.innerHTML = '';

  const tbl  = data?.current_predictions;
  const cols = tbl?.columns || [];
  const rows = tbl?.data || [];
  if (!rows.length) return false;

  const idx = name => cols.indexOf(name);
  const iT = idx('Time');
  const iV = idx('Velocity_kts') >= 0 ? idx('Velocity_kts') : idx('Velocity');
  const iD = idx('Direction_deg');

  for (const r of rows.slice(0, 4)) {
    const when = r[iT], vel = r[iV], dir = iD >= 0 ? r[iD] : null;
    const li = document.createElement('li');
    li.innerHTML =
      `<strong>Event</strong> — ${tzFmt(when)} — ` +
      `<span class="mono">${fmt1(vel)} kt</span>` +
      ` — ${dir != null ? `${fmt0(dir)}° ${toCardinal(dir)}` : '—'}`;
    ul.appendChild(li);
  }
  document.getElementById('currentsStatus').textContent = '';
  return true;
}

// Renders any of: DPAPI table, datagetter predictions, or "cp" vector series
function renderCurrents_DataAPI(data) {
  const ul = document.getElementById('currentsList');
  const statusEl = document.getElementById('currentsStatus');
  ul.innerHTML = '';
  statusEl.textContent = '';

  // ---- Case A: DPAPI-style table {current_predictions:{columns,data}} ----
  const tbl = data?.current_predictions;
  if (tbl && Array.isArray(tbl.columns) && Array.isArray(tbl.data)) {
    const cols = tbl.columns;
    const idx = n => cols.indexOf(n);
    const iT = idx('Time');
    const iV = idx('Velocity_kts') >= 0 ? idx('Velocity_kts') : idx('Velocity');
    const iD = idx('Direction_deg');

    const rows = tbl.data.slice(0, 4);
    if (!rows.length) return false;

    for (const r of rows) {
      const when = r[iT], vel = r[iV], dir = iD >= 0 ? r[iD] : null;
      const li = document.createElement('li');
      li.innerHTML =
        `<strong>Event</strong> — ${tzFmt(when)} — ` +
        `<span class="mono">${fmt1(vel)} kt</span>` +
        ` — ${dir != null ? `${fmt0(dir)}° ${toCardinal(dir)}` : '—'}`;
      ul.appendChild(li);
    }
    return true;
  }

  // ---- Case B: datagetter "predictions" array [{t,v,d}] ----
  let preds = data?.predictions || data?.current_predictions?.predictions
  if (Array.isArray(preds) && preds.length) {
    for (const p of preds.slice(0, 4)) {
      const t = p.t ?? p.Time ?? p.time;
      const v = +(p.v ?? p.Velocity_kts ?? p.velocity ?? NaN);
      const d = p.d ?? p.Direction_deg ?? p.direction ?? null;
      const li = document.createElement('li');
      li.innerHTML =
        `<strong>Event</strong> — ${tzFmt(t)} — ` +
        `<span class="mono">${fmt1(v)} kt</span>` +
        ` — ${d != null ? `${fmt0(d)}° ${toCardinal(d)}` : '—'}`;
      ul.appendChild(li);
    }
    return true;
  }

  // ---- Case C: "cp" vector series (per-minute/hour sample) ----
  // Use Velocity_Major (kt). Direction = meanFloodDir if vel >= 0 else meanEbbDir.
  const cp = data?.current_predictions?.cp;
  if (Array.isArray(cp) && cp.length) {
    for (const r of cp.slice(0, 4)) {
      const t = r.Time || r.time;
      const vel = Number(r.Velocity_Major);
      const dir = vel >= 0 ? Number(r.meanFloodDir) : Number(r.meanEbbDir);
      const li = document.createElement('li');
      li.innerHTML =
        `${tzFmt(t)} — ` +
        `<span class="mono">${fmt1(Math.abs(vel))} kt</span>` +
        ` — ${Number.isFinite(dir) ? `${fmt0(dir)}° ${toCardinal(dir)}` : '—'}`;
      ul.appendChild(li);
    }
    // Show which bin we actually rendered if present
    const bin = cp[0]?.Bin ?? null;
    if (bin) statusEl.textContent = `Bin ${bin}, ${cp.length} samples in window`;
    return true;
  }

  return false;
}

function renderWaves(w) {
  document.getElementById('waveHeight').textContent = fmt1(w.sigWaveHeightFt);
  document.getElementById('wavePeriod').textContent = `${fmt1(w.peakPeriodSec)} s`;
  document.getElementById('waveDir').textContent    = `${fmt0(w.meanDirectionDeg)}° ${toCardinal(w.meanDirectionDeg)}`;
  document.getElementById('wavesTime').textContent  = w.timeISO ? `As of ${tzFmt(w.timeISO)}` : '';
  // upgrade map link to an OSM pin when lat/lon are available
  if (w.lat!=null && w.lon!=null) {
    const z=11;
    document.getElementById('wavesMap').href = `https://www.openstreetmap.org/?mlat=${w.lat}&mlon=${w.lon}#map=${z}/${w.lat}/${w.lon}`;
    addMarker(w.lat, w.lon, 'CDIP 142 (Waves)', document.getElementById('wavesMap').href);
  }
}

// ===== MAP =====
let map, markersLayer, bounds;

function ensureMap() {
  if (map) return map;
  map = L.map('map', { scrollWheelZoom: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  bounds = L.latLngBounds();
  return map;
}

function addMarker(lat, lon, label, linkHref) {
  if (lat == null || lon == null) return;
  ensureMap();
  const opts = {};
  const m = L.marker([lat, lon], opts).addTo(markersLayer);
  const inner = linkHref ? `<a href="${linkHref}" target="_blank" rel="noopener">${label}</a>` : label;
  m.bindPopup(inner);
  bounds.extend([lat, lon]);
}

function fitMarkers() {
  if (!map || !bounds || !bounds.isValid()) return;
  map.fitBounds(bounds.pad(0.2));
}

// NOAA tide/wind station meta (MDAPI only; CORS-safe)
async function getNoaaStationMetaLatLon(stationId) {
  try {
    const u = `https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/${stationId}.json`;
    const r = await fetch(u, { cache: 'no-store' });
    if (!r.ok) return {};
    const j = await r.json();
    const s = j?.stations?.[0] || j?.station || j?.data || j;
    const lat = parseFloat(s?.lat || s?.latitude);
    const lon = parseFloat(s?.lng || s?.lon || s?.longitude);
    return (Number.isFinite(lat) && Number.isFinite(lon)) ? { lat, lon } : {};
  } catch { return {}; }
}

// Currents station meta (use BASE id with MDAPI; no DPAPI)
async function getCurrentsStationLatLon(currentsId) {
  const { base } = splitStationBin(currentsId);
  try {
    const u = `https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/${base}.json`;
    const r = await fetch(u, { cache: 'no-store' });
    if (!r.ok) return {};
    const j = await r.json();
    const s = j?.stations?.[0] || j?.station || j?.data || j;
    const lat = parseFloat(s?.lat || s?.latitude);
    const lon = parseFloat(s?.lng || s?.lon || s?.longitude);
    return (Number.isFinite(lat) && Number.isFinite(lon)) ? { lat, lon } : {};
  } catch { return {}; }
}

// --- Currents station resolver ---
let RESOLVED_CURR_BIN = null; // e.g. "SFB1201_14"
const currentsBaseFrom = id => String(id).split('_')[0];

/* ====== CONTROLLER ====== */
async function refreshAll() {
  // Wind
  getWindLatest()
    .then(renderWind)
    .catch(() => { document.getElementById('windTime').textContent = 'Wind unavailable'; });

  // Tides
  getTidesToday()
    .then(renderTides)
    .catch(() => { document.getElementById('tidesList').innerHTML = '<li>Error loading tides</li>'; });

  // Currents — try configured bin; if empty, probe a few bins and use the first that works.
  (async () => {
    const listEl   = document.getElementById('currentsList');
    const statusEl = document.getElementById('currentsStatus');

    try {
      let resolved = CURRENTS_STATION;                 // e.g., "SFB1201_20"
      let data     = await getCurrentsNext24_DataAPI(resolved);
      let ok       = renderCurrents_DataAPI(data);     // <-- render the Data API table

      if (!ok) {
        const { base } = splitStationBin(resolved);
        statusEl.textContent = 'Checking other bins…';

        // define it here and keep using the same `ok` variable
        const probe = await probeCurrentsBin(base);
        if (probe) {
          resolved = probe.id;                         // e.g., "SFB1201_14"
          data     = probe.data;
          ok       = renderCurrents_DataAPI(data);
          document.getElementById('stationsPill').textContent =
            `Tide/Wind:${NOAA_TIDE_WIND_STATION} • Waves:CDIP142 • Currents:${resolved}`;
        }
      }

      if (!ok) {
        listEl.innerHTML = '<li>No current events in next 24h</li>';
      }
      statusEl.textContent = '';
    } catch (e) {
      listEl.innerHTML = '<li>Error loading currents</li>';
      statusEl.textContent = 'Currents API error (see console).';
      console.error(e);
    }
  })();

  // Waves
  getWavesLatestCDIP142()
    .then(renderWaves)
    .catch(() => { document.getElementById('wavesTime').textContent = 'Waves unavailable'; });

  // ---- MAP MARKERS (run in parallel; safe if some fail) ----
  (async () => {
    document.getElementById('mapStatus').textContent = 'Loading station locations…';
    // Tide/Wind station (same NOAA id)
    try {
      const meta = await getNoaaStationMetaLatLon(NOAA_TIDE_WIND_STATION);
      if (meta.lat!=null && meta.lon!=null) {
        addMarker(meta.lat, meta.lon, `NOAA ${NOAA_TIDE_WIND_STATION} (Tide/Wind)`,
          document.getElementById('tideMap').href);
      }
    } catch {}

    // Fit map to whatever we have (including waves marker added earlier)
    fitMarkers();
    document.getElementById('mapStatus').textContent = '';
  })();
}

// ---- CAMERA SNAPSHOT (updates every 2 min) ----
function refreshCam() {
  const cam = document.getElementById('alamedaCam');
  if (!cam) return;
  const t = Date.now(); // cache-buster
  cam.src = `https://boardsportscalifornia.com/boardsportscalifornia.com/alamedacam.jpg?${t}`;
  const s = document.getElementById('camStatus');
  if (s) s.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
}

refreshAll();
setInterval(refreshAll, REFRESH_MS);
refreshCam();
setInterval(refreshCam, 120000);
</script>
<footer class="site-footer">
  <span id="clock">--:--</span> &nbsp;•&nbsp; Refreshes every 5 min

  <!-- Collapsible sources (keeps IDs, hides clutter on mobile) -->
  <details class="sources">
    <summary>Data sources</summary>
    <div class="pill mono" id="stationsPill"></div>
  </details>
</footer>

</body>
</html>
